<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PULSE â€” IIIT Allahabad (Student + Admin)</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{--accent1:#1e90ff;--accent2:#3aa0ff}
body{
  font-family:"Segoe UI",system-ui,-apple-system,Arial;
  min-height:100vh;background:linear-gradient(135deg,#040b1f,#0a1f44);
  color:#eaf2ff;overflow:hidden;
}
.hidden{display:none!important}
button{cursor:pointer;border:none;background:none;color:inherit;font:inherit}

#login{height:100vh;display:flex;align-items:center;padding-left:60px}
.login-box{width:420px}
h1{font-size:30px;margin-bottom:14px}
h1 span{color:var(--accent1)}
label{font-weight:600;font-size:13px}
input[type=text], input[type=password]{
  width:100%;padding:10px;margin:8px 0 14px;border-radius:8px;border:1px solid rgba(255,255,255,.12);
  background:transparent;color:inherit;
}
.roles{display:flex;gap:10px;margin:8px 0}
.role{flex:1;padding:10px;border-radius:10px;background:rgba(255,255,255,.03);text-align:center;position:relative;overflow:hidden;transition:.22s}
.role:hover{transform:translateY(-6px);box-shadow:0 10px 28px rgba(30,144,255,.18)}
.role.active{outline:2px solid var(--accent1)}
.role::after{content:"";position:absolute;left:-120%;top:0;width:120%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.25),transparent)}
.role:hover::after{left:120%;transition:1s}
.primary{display:block;padding:12px;border-radius:26px;background:linear-gradient(90deg,var(--accent1),var(--accent2));font-weight:800;margin-top:8px}

#app{height:100vh;padding:20px 28px;position:relative}
.topbar{display:flex;justify-content:flex-end;align-items:center}
.profile-icon{width:46px;height:46px;border-radius:50%;background:#fff;color:#071733;display:flex;align-items:center;justify-content:center;font-weight:800;cursor:pointer}

#overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);opacity:0;pointer-events:none;transition:.2s;z-index:40}
#overlay.show{opacity:1;pointer-events:auto}

#profilePanel{position:fixed;left:-320px;top:0;height:100vh;width:300px;background:#071a33;padding:18px;transition:.28s;z-index:50;box-shadow:8px 0 30px rgba(0,0,0,.5)}
#profilePanel.show{left:0}
#profilePanel h3{margin-bottom:12px}
.p-item{padding:10px;border-radius:8px;margin:8px 0;cursor:pointer}
.p-item:hover{background:rgba(255,255,255,.02);color:var(--accent1)}
.small-muted{font-size:12px;color:#9fb6d9;margin-top:6px}

.home-content{padding-top:10px;transition:.2s}
.home-content.disabled{pointer-events:none;filter:blur(2px) brightness(.95)}
.greet{font-size:30px;margin:12px 0}
.greet span{color:var(--accent1);text-transform:capitalize}

.section-title{margin:16px 0 10px;font-size:16px}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:18px}
.card{background:#163c52;padding:14px;border-radius:14px;transition:.22s;cursor:pointer}
.card:hover{transform:translateY(-8px);box-shadow:0 18px 46px rgba(0,0,0,.5)}
.card.class{background:#6c9a3a}
.actions{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:12px}
.action{background:rgba(255,255,255,.04);padding:10px;border-radius:10px;text-align:center;cursor:pointer}
.action:hover{background:rgba(30,144,255,.12)}

.modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%) scale(.98);background:#081a2b;padding:18px;border-radius:10px;z-index:60;min-width:300px;max-width:92vw;opacity:0;pointer-events:none;transition:.18s}
.modal.show{opacity:1;transform:translate(-50%,-50%) scale(1);pointer-events:auto}

#viewer.modal{width:92vw;height:88vh;max-width:1400px;max-height:92vh;display:flex;flex-direction:column;overflow:hidden}
#viewerContent{flex:1;overflow:auto}
#viewerContent iframe{width:100%;height:100%;border:none;border-radius:8px}

.events-list{display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto}
.event-item{padding:10px;border-radius:8px;background:rgba(255,255,255,.02);cursor:pointer;display:flex;justify-content:space-between;align-items:center}
.event-item:hover{background:rgba(30,144,255,.06)}

.table{width:100%;border-collapse:collapse;margin-top:8px}
.table th,.table td{padding:8px;border-bottom:1px solid rgba(255,255,255,.03);font-size:14px}

#todoPanel{position:fixed;right:-360px;top:0;height:100vh;width:340px;background:#071a33;padding:12px;transition:.28s;z-index:55}
#todoPanel.show{right:0}
.todo-item{background:rgba(255,255,255,.03);padding:8px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.todo-item.done{opacity:.6;text-decoration:line-through}

.small-btn{padding:6px 10px;border-radius:8px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#071733;font-weight:700}
.ghost{padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.06)}
.info{font-size:13px;color:#bcd6f7}

@media(max-width:900px){.grid{grid-template-columns:1fr}.actions{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>

<section id="login">
  <div class="login-box">
    <h1>Sign in to <span>pulse</span></h1>
    <label for="email">Email</label>
    <input id="email" type="text" placeholder="you@iiita.ac.in">
    <label for="pwd">Password (optional)</label>
    <input id="pwd" type="password" placeholder="">
    <div class="roles" id="roleRow">
      <div class="role" data-role="student">Student</div>
      <div class="role" data-role="admin">Admin</div>
    </div>
    <button class="primary" id="continueBtn">Continue</button>
    <div class="small-muted">No backend yet â€” role selection is for demo.</div>
  </div>
</section>

<section id="app" class="hidden">
  <div id="overlay" aria-hidden="true"></div>

  <aside id="profilePanel" aria-hidden="true">
    <h3 id="panelName">User</h3>
    <div id="p-items"></div>
    <div style="margin-top:18px">
      <div class="p-item" id="p-settings">Settings</div>
      <div class="p-item" id="p-logout">Logout</div>
    </div>
  </aside>

  <aside id="todoPanel" aria-hidden="true">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <strong>To-Do</strong>
      <button id="closeTodo" class="ghost">Close</button>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:10px">
      <input id="newTask" placeholder="Add task" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,.06);background:transparent;color:inherit">
      <button id="addTask" class="small-btn">+</button>
    </div>
    <div id="todoList"></div>
  </aside>

  <div class="home-content" id="homeContent">
    <div class="topbar">
      <div class="profile-icon" id="profileIcon">U</div>
    </div>

    <div class="greet">Good evening, <span id="userDisplay">guest</span></div>

    <div id="studentOnlySection" class="section">
      <div class="section-title">Upcoming Classes</div>
      <div class="grid" id="classesGrid">
        <div class="card class"><strong>Principle of Management</strong><div class="info">8:50 AM, Tomorrow</div></div>
        <div class="card class"><strong>Data Structures</strong><div class="info">10:30 AM, Tomorrow</div></div>
      </div>
    </div>

    <div class="section-title">Upcoming Events</div>
    <div class="grid" id="eventsGrid"></div>

    <div class="section-title">Quick Actions</div>
    <div class="actions" id="quickActions"></div>
  </div>
</section>

<div id="eventsModal" class="modal" aria-hidden="true">
  <h3 id="eventsModalTitle">Events</h3>
  <div id="eventsBody"></div>
  <div class="controls"><button id="closeEvents" class="ghost">Close</button></div>
</div>

<div id="eventDetailModal" class="modal" aria-hidden="true">
  <h3 id="edTitle">Event</h3>
  <div id="edDesc" style="margin-top:8px"></div>
  <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
    <button id="edEnroll" class="small-btn">Participate / Enroll</button>
    <button id="edClose" class="ghost">Close</button>
  </div>
</div>

<div id="enrollModal" class="modal" aria-hidden="true">
  <h3 id="enrollTitle">Enrolled Students</h3>
  <div id="enrollCount" class="info" style="margin-bottom:8px"></div>
  <table class="table" id="enrollTable"><thead><tr><th>Student</th><th>Status</th><th>Action</th></tr></thead><tbody></tbody></table>
  <div class="controls"><button id="enrollClose" class="ghost">Close</button></div>
</div>

<div id="viewer" class="modal" aria-hidden="true">
  <div id="viewerContent"></div>
  <div class="controls"><button id="closeViewer" class="ghost">Close</button></div>
</div>

<script>
const EVENTS_KEY = "pulse_events_v1";
const TODOS_KEY = "pulse_todos_v1";

function uid(prefix){return (prefix||"id")+"_"+Math.random().toString(36).slice(2,9)}
function saveEvents(ev){localStorage.setItem(EVENTS_KEY,JSON.stringify(ev))}
function loadEvents(){try{return JSON.parse(localStorage.getItem(EVENTS_KEY)||"[]")}catch(e){return[]}}
function saveUserTodosKey(key,list){localStorage.setItem(key,JSON.stringify(list))}
function loadUserTodosKey(key){try{return JSON.parse(localStorage.getItem(key)||"[]")}catch(e){return[]}}

const login = document.getElementById("login")
const app = document.getElementById("app")
const continueBtn = document.getElementById("continueBtn")
const rolesRow = document.getElementById("roleRow")
const roleButtons = rolesRow.querySelectorAll(".role")
const emailInput = document.getElementById("email")
const pwdInput = document.getElementById("pwd")

const overlay = document.getElementById("overlay")
const profilePanel = document.getElementById("profilePanel")
const pItemsContainer = document.getElementById("p-items")
const panelName = document.getElementById("panelName")
const profileIcon = document.getElementById("profileIcon")
const userDisplay = document.getElementById("userDisplay")
const studentOnlySection = document.getElementById("studentOnlySection")

const homeContent = document.getElementById("homeContent")
const eventsGrid = document.getElementById("eventsGrid")
const quickActions = document.getElementById("quickActions")

const eventsModal = document.getElementById("eventsModal")
const eventsBody = document.getElementById("eventsBody")
const closeEvents = document.getElementById("closeEvents")

const eventDetailModal = document.getElementById("eventDetailModal")
const edTitle = document.getElementById("edTitle")
const edDesc = document.getElementById("edDesc")
const edEnroll = document.getElementById("edEnroll")
const edClose = document.getElementById("edClose")

const enrollModal = document.getElementById("enrollModal")
const enrollTitle = document.getElementById("enrollTitle")
const enrollCount = document.getElementById("enrollCount")
const enrollTableBody = document.querySelector("#enrollTable tbody")
const enrollClose = document.getElementById("enrollClose")

const viewer = document.getElementById("viewer")
const viewerContent = document.getElementById("viewerContent")
const closeViewer = document.getElementById("closeViewer")

const todoPanel = document.getElementById("todoPanel")
const todoListEl = document.getElementById("todoList")
const addTaskBtn = document.getElementById("addTask")
const newTaskInput = document.getElementById("newTask")
const closeTodo = document.getElementById("closeTodo")

let currentUser = null
let events = loadEvents()

if(events.length===0){
  events = [
    {id:uid("ev"),title:"Out Of Context",dates:"23â€“25 January",desc:"Competition across multiple tracks. Teams of 1-4 members.",enrolled:[]},
    {id:uid("ev"),title:"Effervescence",dates:"20â€“22 February",desc:"Cultural fest with performances, contests and food stalls.",enrolled:[]}
  ]
  saveEvents(events)
}

function showOverlay(){overlay.classList.add("show");homeContent.classList.add("disabled")}
function hideOverlay(){overlay.classList.remove("show");homeContent.classList.remove("disabled")}
function anyPanelOpen(){return [profilePanel,eventsModal,eventDetailModal,enrollModal,viewer,todoPanel].some(el=>el.classList && el.classList.contains("show"))}
function openPanel(el){el.classList.add("show");showOverlay()}
function closePanel(el){el.classList.remove("show");if(!anyPanelOpen())hideOverlay()}
function openModal(el){el.classList.add("show");showOverlay()}
function closeModal(el){el.classList.remove("show");if(!anyPanelOpen())hideOverlay()}

overlay.addEventListener("click",()=>{
  [viewer,enrollModal,eventDetailModal,eventsModal,profilePanel,todoPanel].forEach(el=>el.classList.remove("show"))
  hideOverlay()
})

let selectedRole = null
roleButtons.forEach(b=>{
  b.addEventListener("click",()=>{
    roleButtons.forEach(x=>x.classList.remove("active"))
    b.classList.add("active")
    selectedRole = b.dataset.role
  })
})

continueBtn.addEventListener("click",()=>{
  const email = (emailInput.value||"").trim()
  if(!selectedRole) return alert("Choose Student or Admin")
  if(!email) return alert("Enter an email to identify yourself (demo)")
  currentUser = {email,name:email.split("@")[0]||email,role:selectedRole}
  login.classList.add("hidden")
  app.classList.remove("hidden")
  initForRole()
  renderEventsGrid()
  renderQuickActions()
  renderTodos()
})

function initForRole(){
  panelName.textContent = currentUser.name
  userDisplay.textContent = currentUser.name
  profileIcon.textContent = currentUser.name[0].toUpperCase()
  studentOnlySection.style.display = currentUser.role==="student" ? "" : "none"
  pItemsContainer.innerHTML = ""
  if(currentUser.role==="student"){
    addPItem("View Profile",()=>{alert(`Profile\n\nName: ${currentUser.name}\nEmail: ${currentUser.email}\nRole: Student`)})
    addPItem("Events",()=>openEventsModalFor("student"))
    addPItem("Mess Menu",()=>openViewerFile("mess.pdf"))
    addPItem("Calendar",()=>openViewerFile("timetable.pdf"))
    addPItem("To-Do",()=>toggleTodo())
  } else if(currentUser.role==="admin"){
    addPItem("Events (Manage)",()=>openEventsModalFor("admin"))
    addPItem("Mess Menu",()=>openViewerFile("mess.pdf"))
    addPItem("To-Do",()=>toggleTodo())
  }
}

function addPItem(text,handler){
  const el=document.createElement("div")
  el.className="p-item"
  el.textContent=text
  el.onclick=()=>{handler()}
  pItemsContainer.appendChild(el)
}

profileIcon.addEventListener("click",()=>{
  if(profilePanel.classList.contains("show")) closePanel(profilePanel)
  else openPanel(profilePanel)
})

document.getElementById("p-logout").addEventListener("click",()=>{
  closePanel(profilePanel)
  app.classList.add("hidden")
  login.classList.remove("hidden")
  selectedRole = null
  roleButtons.forEach(x=>x.classList.remove("active"))
  emailInput.value = ""
  pwdInput.value = ""
  currentUser = null
})

function renderEventsGrid(){
  eventsGrid.innerHTML = ""
  events.forEach(ev=>{
    const wrapper=document.createElement("div")
    wrapper.className="card"
    wrapper.innerHTML=`<strong>${ev.title}</strong><div class="info" style="font-size:13px">${ev.dates}</div><div style="margin-top:8px;font-size:13px;color:#bcd6f7">${ev.desc}</div>`
    if(currentUser && currentUser.role==="admin"){
      const badge=document.createElement("div")
      badge.style.cssText="margin-top:8px;font-weight:700;color:#0b2140;background:linear-gradient(90deg,var(--accent1),var(--accent2));display:inline-block;padding:6px 8px;border-radius:999px;font-size:13px"
      badge.textContent=`${ev.enrolled.length} registered`
      wrapper.appendChild(badge)
      wrapper.addEventListener("click",()=>openAdminEventManage(ev.id))
    } else {
      wrapper.addEventListener("click",()=>openEventDetail(ev.id))
    }
    eventsGrid.appendChild(wrapper)
  })
}

function openEventsModalFor(mode){
  eventsModal.querySelector("#eventsModalTitle").textContent = mode==="admin" ? "Manage Events" : "Events"
  eventsBody.innerHTML = ""
  if(mode==="admin"){
    const form=document.createElement("div")
    form.innerHTML=`
      <div style="display:flex;flex-direction:column;gap:8px">
        <input id="admin_ev_title" placeholder="Event title" style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,.06);background:transparent;color:inherit">
        <input id="admin_ev_dates" placeholder="Dates (e.g. 20-22 Feb)" style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,.06);background:transparent;color:inherit">
        <input id="admin_ev_desc" placeholder="Short description" style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,.06);background:transparent;color:inherit">
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
          <button id="adminAddEv" class="small-btn">Add Event</button>
        </div>
      </div>
      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,.03)">
    `
    eventsBody.appendChild(form)
    document.getElementById("adminAddEv").addEventListener("click",()=>{
      const title=document.getElementById("admin_ev_title").value.trim()
      const dates=document.getElementById("admin_ev_dates").value.trim()
      const desc=document.getElementById("admin_ev_desc").value.trim()
      if(!title) return alert("Title required")
      const newEv={id:uid("ev"),title,dates:dates||"TBA",desc:desc||"",enrolled:[]}
      events.unshift(newEv)
      saveEvents(events)
      renderEventsGrid()
      openEventsModalFor("admin")
    })
  }
  const list=document.createElement("div")
  list.className="events-list"
  events.forEach(ev=>{
    const it=document.createElement("div")
    it.className="event-item"
    it.innerHTML=`<div style="flex:1"><strong>${ev.title}</strong><div class="info">${ev.dates}</div></div>`
    const right=document.createElement("div")
    right.style.display="flex";right.style.gap="8px"
    if(mode==="admin"){
      const manageBtn=document.createElement("button");manageBtn.className="ghost";manageBtn.textContent="Manage"
      manageBtn.onclick=(e)=>{e.stopPropagation();openAdminEventManage(ev.id)}
      const delBtn=document.createElement("button");delBtn.className="ghost";delBtn.textContent="Delete"
      delBtn.onclick=(e)=>{e.stopPropagation();if(confirm(`Delete event ${ev.title}?`)){events=events.filter(x=>x.id!==ev.id);saveEvents(events);renderEventsGrid();openEventsModalFor("admin")}}
      right.appendChild(manageBtn);right.appendChild(delBtn)
    } else {
      const status=ev.enrolled.find(en=>en.email===currentUser.email)
      const badge=document.createElement("div")
      badge.textContent = status ? (status.status==="disqualified"?"Disqualified":(status.status==="selected"?"Selected":"Enrolled")) : "Not enrolled"
      badge.style.cssText="font-size:13px;padding:6px;border-radius:999px;background:rgba(255,255,255,.04)"
      right.appendChild(badge)
      const detailBtn=document.createElement("button");detailBtn.className="ghost";detailBtn.textContent="Details"
      detailBtn.onclick=(e)=>{e.stopPropagation();openEventDetail(ev.id)}
      right.appendChild(detailBtn)
    }
    it.appendChild(right)
    list.appendChild(it)
  })
  eventsBody.appendChild(list)
  openModal(eventsModal)
  closeEvents.onclick=()=>closeModal(eventsModal)
}

function openEventDetail(evId){
  const ev=events.find(e=>e.id===evId)
  if(!ev) return alert("Event not found")
  edTitle.textContent=ev.title
  edDesc.innerHTML=`<div class="info">${ev.dates}</div><div style="margin-top:8px">${ev.desc}</div>`
  const enrolledRec=ev.enrolled.find(en=>en.email===currentUser.email)
  if(enrolledRec){
    if(enrolledRec.status==="disqualified"){edEnroll.textContent="You were disqualified";edEnroll.disabled=true}
    else{edEnroll.textContent="Enrolled âœ“";edEnroll.disabled=true}
  } else {edEnroll.textContent="Participate / Enroll";edEnroll.disabled=false}
  edEnroll.onclick=()=>{
    if(!currentUser||currentUser.role!=="student") return alert("Only students can enroll")
    if(ev.enrolled.find(en=>en.email===currentUser.email)) return alert("Already enrolled")
    ev.enrolled.push({email:currentUser.email,name:currentUser.name,status:"enrolled",joinedAt:new Date().toISOString()})
    saveEvents(events)
    renderEventsGrid()
    openEventDetail(evId)
    alert("Enrolled â€” admin will review registrations")
  }
  edClose.onclick=()=>closeModal(eventDetailModal)
  openModal(eventDetailModal)
}

function openAdminEventManage(evId){
  const ev=events.find(e=>e.id===evId)
  if(!ev) return alert("Event not found")
  enrollTitle.textContent=`Enrolled â€” ${ev.title}`
  enrollCount.textContent=`${ev.enrolled.length} registered`
  enrollTableBody.innerHTML=""
  ev.enrolled.forEach((en,idx)=>{
    const tr=document.createElement("tr")
    const tName=document.createElement("td");tName.textContent=en.name+" ("+en.email+")"
    const tStatus=document.createElement("td");tStatus.textContent=en.status
    const tAction=document.createElement("td")
    const disqBtn=document.createElement("button");disqBtn.className="ghost";disqBtn.textContent=(en.status==="disqualified"?"Restore":"Disqualify")
    disqBtn.onclick=()=>{en.status=en.status==="disqualified"?"enrolled":"disqualified";saveEvents(events);openAdminEventManage(evId);renderEventsGrid()}
    const selBtn=document.createElement("button");selBtn.className="small-btn";selBtn.textContent="Mark Selected"
    selBtn.onclick=()=>{en.status="selected";saveEvents(events);openAdminEventManage(evId);renderEventsGrid()}
    tAction.appendChild(disqBtn);tAction.appendChild(selBtn)
    tr.appendChild(tName);tr.appendChild(tStatus);tr.appendChild(tAction)
    enrollTableBody.appendChild(tr)
  })
  const existing=enrollModal.querySelector(".exportwrap");if(existing)existing.remove()
  const wrap=document.createElement("div");wrap.className="exportwrap";wrap.style.marginTop="8px"
  const exportBtn=document.createElement("button");exportBtn.className="small-btn";exportBtn.textContent="Export CSV"
  exportBtn.onclick=()=>{
    const rows=[["name","email","status","joinedAt"]];ev.enrolled.forEach(r=>rows.push([r.name,r.email,r.status,r.joinedAt||""]))
    const csv=rows.map(r=>r.map(c=>`"${String(c||"").replace(/"/g,'""')}"`).join(",")).join("\n")
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"})
    const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download=(ev.title.replace(/\s+/g,"_")||"event")+"_enrollments.csv";document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url)
  }
  wrap.appendChild(exportBtn);enrollModal.querySelector("h3").parentElement.insertBefore(wrap,enrollModal.querySelector(".info")?.nextSibling||enrollModal.querySelector("table"))
  openModal(enrollModal)
}
enrollClose.addEventListener("click",()=>closeModal(enrollModal))

function openViewerFile(src){
  const ext=src.split(".").pop().toLowerCase()
  if(ext==="pdf"){viewerContent.innerHTML=`<iframe src="${src}"></iframe>`}
  else{viewerContent.innerHTML=`<img src="${src}" style="max-width:80vw;max-height:70vh;border-radius:8px">`}
  openModal(viewer)
}
closeViewer.onclick=()=>closeModal(viewer)

function todosKeyForUser(){return TODOS_KEY+"_"+(currentUser?currentUser.email:"guest")}
function loadUserTodos(){return loadUserTodosKey(todosKeyForUser())}
function saveUserTodos(list){saveUserTodosKey(todosKeyForUser(),list)}

function renderTodos(){
  const list=loadUserTodos()
  todoListEl.innerHTML=""
  list.forEach((t,idx)=>{
    const it=document.createElement("div");it.className="todo-item"+(t.done?" done":"")
    const left=document.createElement("div");left.textContent=t.text
    const right=document.createElement("div");right.style.display="flex";right.style.gap="8px"
    const del=document.createElement("button");del.className="ghost";del.textContent="Delete"
    del.onclick=()=>{list.splice(idx,1);saveUserTodos(list);renderTodos()}
    const tog=document.createElement("button");tog.className="small-btn";tog.textContent=t.done?"Undo":"Done"
    tog.onclick=()=>{list[idx].done=!list[idx].done;saveUserTodos(list);renderTodos()}
    right.appendChild(del);right.appendChild(tog)
    it.appendChild(left);it.appendChild(right)
    todoListEl.appendChild(it)
  })
}
addTaskBtn.addEventListener("click",()=>{
  const txt=newTaskInput.value.trim();if(!txt) return
  const list=loadUserTodos();list.unshift({text:txt,done:false});saveUserTodos(list);newTaskInput.value="";renderTodos()
})
closeTodo.addEventListener("click",()=>{
  todoPanel.classList.remove("show")
  if(!anyPanelOpen()) hideOverlay()
})

function toggleTodo(){
  if(todoPanel.classList.contains("show")) closePanel(todoPanel)
  else{ openPanel(todoPanel); renderTodos() }
}

function renderQuickActions(){
  quickActions.innerHTML=""
  if(currentUser.role==="student"){
    addQuick("ðŸ½ Mess",()=>openViewerFile("mess.pdf"))
    addQuick("ðŸ“… Calendar",()=>openViewerFile("timetable.pdf"))
    addQuick("âœ… To-Do",()=>toggleTodo())
    addQuick("ðŸ“Œ Events",()=>openEventsModalFor("student"))
  } else if(currentUser.role==="admin"){
    addQuick("ðŸ½ Mess",()=>openViewerFile("mess.pdf"))
    addQuick("âœ… To-Do",()=>toggleTodo())
    addQuick("ðŸ“Œ Events (Manage)",()=>openEventsModalFor("admin"))
    addQuick("Export All Events CSV",()=>{
      const rows=[["event","student","email","status","joinedAt"]];events.forEach(ev=>ev.enrolled.forEach(en=>rows.push([ev.title,en.name,en.email,en.status,en.joinedAt||""])))
      const csv=rows.map(r=>r.map(c=>`"${String(c||"").replace(/"/g,'""')}"`).join(",")).join("\n")
      const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"})
      const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download="pulse_all_events_enrollments.csv";document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url)
    })
  } else {
    addQuick("ðŸ½ Mess",()=>openViewerFile("mess.pdf"))
    addQuick("âœ… To-Do",()=>toggleTodo())
    addQuick("ðŸ“Œ Events (Faculty)",()=>openEventsModalFor("faculty"))
  }
}

function addQuick(label,handler){
  const el=document.createElement("div");el.className="action";el.textContent=label;el.onclick=handler;quickActions.appendChild(el)
}

function saveEventsAndRefresh(){saveEvents(events);renderEventsGrid()}

function renderInitial(){if(!currentUser) return;renderEventsGrid();renderQuickActions();renderTodos()}

document.addEventListener("click",function(e){ if(eventDetailModal.classList.contains("show") && !eventDetailModal.contains(e.target) && !e.target.closest(".event-item")){} })
edClose.addEventListener("click",()=>closeModal(eventDetailModal))
closeEvents.addEventListener("click",()=>closeModal(eventsModal))
renderInitial()
</script>
</body>
</html>